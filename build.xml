<project xmlns:ivy="antlib:org.apache.ivy.ant" name="markdownBlog" default="build" basedir=".">
  <description>
      A blog powered by markdown2
  </description>
  <property file="build.properties"/>

  <target name="resolve"
          description="Resolve ivy">
    <ivy:retrieve conf="source"/>
    <ivy:retrieve conf="lib"
                  pattern="lib/[module]/[artifact].[ext]" />
    <unzip src="lib/${epiceditor}.zip"
           dest="lib"/>
  </target>

  <target name="yuicompressor">
    <echo message="compressing: ${in}"/>
    <java jar="${yuijar}"
          fork="true"
          failonerror="true">
      <arg value="--nomunge"/>
      <arg value="-o"/>
      <arg value="${out}"/>
      <arg value="${in}"/>
    </java>
  </target>

  <target name="jshint">
    <echo message="jshint: ${in}"/>
    <exec executable="jshint" output="jshint.out" append="true" failonerror="true">
      <arg value="${in}"/>
    </exec>
  </target>

  <target name="run-jshint">
    <property name="src.js" location="${blogapp}/static/js"/>
    <delete file="jshint.out"/>
    <antcall target="jshint">
      <param name="in" value="${blogapp}/admin/static/admin.js"/>
    </antcall>
    <antcall target="jshint">
      <param name="in" value="${blogapp}/admin/static/ng.js"/>
    </antcall>
    <antcall target="jshint">
      <param name="in" value="${src.js}/blog.js"/>
    </antcall>
    <antcall target="jshint">
      <param name="in" value="${src.js}/ng.js"/>
    </antcall>
    <antcall target="jshint">
      <param name="in" value="${utilapp}/ng.js"/>
    </antcall>
  </target>

  <target name="init" depends="run-jshint">
    <!-- create the time stamp -->
    <tstamp/>
    <!-- get markdown2 package directory -->
    <exec executable="python" outputproperty="markdown2">
      <arg value="-c"/>
      <arg value="import markdown2; print markdown2.__file__[0:-1]"/>
    </exec>
  </target>

  <target name="build-libs">
    <subant target="">
      <fileset file="build.libs.xml"/>
    </subant>
  </target>

  <target name="build" depends="init, build-libs"
          description="generate the distribution" >
    <!-- Create the distribution directory -->
    <mkdir dir="${build}"/>

    <!-- Copy src -->
    <copy todir="${build}">
      <fileset dir="${main}"/>
    </copy>

    <copy todir="${build}/test">
      <fileset dir="${test}"/>
    </copy>

    <!-- Copy lib -->
    <copy todir="${build}/app/bloglib">
      <fileset dir="lib/bloglib"/>
    </copy>
    <copy file="lib/${lesscss}" tofile="${build.blog.js}/less.js"/>
    <copy todir="${build.blog.static}" force="true">
      <fileset dir="lib/${epiceditor}"/>
    </copy>
    <copy file="${markdown2}" todir="${build}"/>
    <copy file="lib/werkzeug.zip" todir="${build}"/>
    <copy file="lib/flask.zip" todir="${build}"/>
  </target>

  <target name="dist" depends="build"
          description="generate the distribution" >
    <!-- create the distribution directory -->
    <mkdir dir="${dist}"/>

    <!-- copy src -->
    <copy todir="${dist}">
      <fileset dir="${build}/">
        <exclude name="**/test/"/>
      </fileset>
    </copy>

    <!-- copy/move lib -->
    <move file="${dist.static}/epiceditor/js/epiceditor.min.js"
          tofile="${dist.static}/epiceditor/js/epiceditor.js" force="true"/>
    <antcall target="compress"/>
  </target>

  <target name="compress">
    <!-- compress js files for blog -->
    <antcall target="yuicompressor">
      <param name="in" value="${dist}/blog/admin/admin.js"/>
      <param name="out" value="${dist}/blog/admin/admin.js"/>
      <param name="type" value="js"/>
    </antcall>

    <antcall target="yuicompressor">
      <param name="in" value="${dist}/blog/admin/ng.js"/>
      <param name="out" value="${dist}/blog/admin/ng.js"/>
      <param name="type" value="js"/>
    </antcall>

    <antcall target="yuicompressor">
      <param name="in" value="${dist.js}/blog.js"/>
      <param name="out" value="${dist.js}/blog.js"/>
      <param name="type" value="js"/>
    </antcall>

    <antcall target="yuicompressor">
      <param name="in" value="${dist.js}/ng.js"/>
      <param name="out" value="${dist.js}/ng.js"/>
      <param name="type" value="js"/>
    </antcall>

    <!-- compress js files for util -->
    <antcall target="yuicompressor">
      <param name="in" value="${dist}/util/ng.js"/>
      <param name="out" value="${dist}/util/ng.js"/>
      <param name="type" value="js"/>
    </antcall>
  </target>

  <target name="test" depends="build"
          description="unit test">
    <!-- Execute the unittest -->
    <exec executable="python" dir="${build}\test\serverside">
      <arg value="testmycommentapi.py"/>
      <arg value="${gaesdk}"/>
    </exec>

    <exec executable="python" dir="${build}\test\serverside">
      <arg value="testmyblogapi.py"/>
      <arg value="${gaesdk}"/>
    </exec>
  </target>

  <target name="clean"
          description="clean up">
    <!-- Delete the ${build} and ${dist} directory trees -->
    <delete dir="${build}"/>
    <delete dir="${dist}"/>
    <delete dir="lib"/>
  </target>

  <target name="cleanivy"
          description="clean ivy cache">
    <ivy:cleancache />
  </target>
</project>
